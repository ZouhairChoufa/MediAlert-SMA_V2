creer_l_alerte:
  description: |-
    Capturer et normaliser les données brutes de l'alerte pour le patient {nom_prenom} ({age} ans, {sexe}).
    
    1. Analyse de la Localisation :
       - Si des coordonnées GPS précises sont fournies (via le navigateur), les utiliser en priorité absolue.
       - Si seule une adresse textuelle est fournie, la géocoder.
       - Si aucune adresse n'est fournie, utiliser la localisation IP comme fallback.
       - Input Localisation: "{localisation}" (Adresse ou coords).
    
    2. Analyse des Symptômes :
       - Symptômes bruts : "{symptomes}".
       - Identifier si le patient est conscient ou inconscient.
  expected_output: |-
    JSON strict:
    {
      "alert_id": "UUID",
      "timestamp": "ISO8601",
      "patient_data": {
        "nom": "{nom_prenom}",
        "age": {age},
        "sexe": "{sexe}",
        "symptomes_bruts": "{symptomes}",
        "conscience": "CONSCIENT|INCONSCIENT|ALTERÉ"
      },
      "localisation": {
        "adresse_detectee": "string",
        "source": "GPS|MANUEL|IP",
        "coordonnees": {
          "lat": "float",
          "lng": "float"
        },
        "precision_estimee_metres": "integer"
      }
    }
  agent: agentpatient

analyse_medicale_d_urgence:
  description: |-
    URGENT : Effectuer un triage médical avancé basé sur les données de 'creer_l_alerte'.
    
    1. Score de Gravité : Calculer le score CCMU (1-5) ou ESI.
       - Mots-clés critiques à détecter : "douleur thoracique", "apnée", "hémorragie", "inconscient".
    2. Vecteur d'Intervention : Déterminer le type de véhicule.
       - SMUR (Médecin + Infirmier) pour CCMU 1 & 2.
       - Ambulance de Secours (VSAV) pour CCMU 3.
       - Ambulance Simple / VSL pour CCMU 4 & 5.
    3. Risques : Identifier les risques immédiats (Arrêt cardiaque imminent, AVC, Choc).
  expected_output: |-
    JSON strict:
    {
      "triage_medical": {
        "score_ccmu": "integer (1-5)",
        "niveau_gravite": "CRITIQUE|URGENT|RELATIF",
        "urgence_vitale_suspectee": "boolean",
        "type_vecteur_requis": "SMUR|AMBULANCE_SECOURS|VSL",
        "specialite_requise": "CARDIOLOGIE|NEUROLOGIE|TRAUMATOLOGIE|GENERAL",
        "hypotheses_diagnostiques": ["string"],
        "risque_evolution": "STABLE|INSTABLE"
      }
    }
  agent: agentmedecinurgence
  context:
  - creer_l_alerte

triage_patients_et_selection_ambulance:
  description: |-
    Orchestration Logistique Intelligente.
    
    1. Sélection de l'Hôpital :
       - Utiliser le `SmartDispatchEngine` pour trouver l'hôpital le plus proche CAPABLE de traiter la `specialite_requise` (ex: ne pas envoyer un AVC dans un hôpital sans IRM).
       - Calculer la distance réelle (route) et non à vol d'oiseau.
    
    2. Sélection de l'Ambulance :
       - Identifier l'unité disponible la plus proche du patient correspondant au `type_vecteur_requis`.
  expected_output: |-
    JSON strict:
    {
      "decision_operationnelle": {
        "statut": "ASSIGNED",
        "ambulance_assignee": {
            "id": "string",
            "type": "string",
            "base_depart": "string"
        },
        "hopital_cible": {
            "id": "string",
            "nom": "string",
            "service_cible": "string",
            "capacite_lits": "DISPONIBLE|SATURE",
            "raison_choix": "string (ex: Hôpital le plus proche avec Unité Neurovasculaire)"
        }
      }
    }
  agent: agentcordonnateur
  context:
  - creer_l_alerte
  - analyse_medicale_d_urgence

valider_la_demande_du_coordonnateur:
  description: |-
    Calcul de Trajectoire Précise (OpenRouteService).
    
    1. Segment A (Ambulance -> Patient) : Calculer temps d'approche réel avec trafic.
    2. Segment B (Patient -> Hôpital) : Calculer temps d'évacuation.
    3. Générer la Polyline encodée pour l'affichage sur la carte en temps réel.
  expected_output: |-
    JSON strict:
    {
      "logistique": {
        "temps_total_mission_min": "integer",
        "segment_aller": {
            "eta_patient_minutes": "integer",
            "distance_km": "float"
        },
        "segment_retour": {
            "eta_hopital_minutes": "integer",
            "distance_km": "float"
        },
        "itineraire": {
            "polyline_encodee": "string",
            "points_passage": ["lat,lng"]
        },
        "heure_arrivee_estimee_hopital": "ISO8601"
      }
    }
  agent: agentambulence
  context:
  - triage_patients_et_selection_ambulance

recevoir_les_patients:
  description: |-
    Activation des Ressources Hospitalières.
    
    Sur la base de l'ETA calculé :
    1. Réserver physiquement le lit ou le box de déchocage.
    2. Notifier l'équipe de garde (Urgentiste, Spécialiste) de l'heure exacte d'arrivée.
    3. Préparer le matériel spécifique (ex: Plateau technique AVC).
  expected_output: |-
    JSON strict:
    {
      "accueil_hopital": {
        "statut_lit": "RESERVED",
        "numero_lit": "string",
        "equipe_mobilisee": ["Urgentiste", "Infirmier", "Brancardier"],
        "instructions_acces": "string (ex: Porte Urgences A - Code rouge)"
      }
    }
  agent: agenthopital
  context:
  - analyse_medicale_d_urgence
  - valider_la_demande_du_coordonnateur

traitement_du_specialiste:
  description: |-
    Support Clinique Pré-Hospitalier.
    
    Générer un protocole "Just-in-Time" pour l'équipe ambulancière pendant le trajet.
    - Liste des gestes à effectuer avant l'arrivée (ex: poser voie veineuse, ECG).
    - Préparation des médicaments à l'hôpital.
  expected_output: |-
    JSON strict:
    {
      "support_clinique": {
        "protocole_transport": "string (Gestes à faire dans l'ambulance)",
        "checklist_accueil": ["string (ex: Préparer Thrombolyse)", "string (ex: Scanner libre)"],
        "medicaments_a_preparer": ["string"]
      }
    }
  agent: agentmedecinspecialiste
  context:
  - analyse_medicale_d_urgence

consolider_dossier_pour_ui:
  description: |-
    Génération du "Digital Twin" de l'intervention pour le Dashboard.
    
    Fusionner TOUTES les données (Médical, Geo, Logistique) en un objet unique pour le frontend.
    L'objet doit être directement consommable par le Javascript de la carte (Leaflet).
  expected_output: |-
    JSON strict FINAL pour le Frontend:
    {
      "ui_view": {
        "message_patient": "string (ex: Une équipe SMUR arrive dans 5 min)",
        "timeline": {
          "alerte_recue": "ISO8601",
          "triage_effectue": "ISO8601",
          "ambulance_en_route": "ISO8601",
          "arrivee_prevue_hopital": "ISO8601"
        },
        "details_techniques": {
            "ambulance": {
                "id": "string",
                "eta_display": "string",
                "position_actuelle": {"lat": "float", "lng": "float"}
            },
            "hopital": {
                "nom": "string",
                "service": "string",
                "distance_display": "string"
            },
            "medical": {
                "gravite_display": "string",
                "vecteur": "string"
            },
            "carte": {
                "route_polyline": "string (pour affichage Leaflet)",
                "bounds": [[lat,lng], [lat,lng]]
            }
        }
      }
    }
  agent: agentadministratif
  context:
  - creer_l_alerte
  - analyse_medicale_d_urgence
  - triage_patients_et_selection_ambulance
  - valider_la_demande_du_coordonnateur
  - recevoir_les_patients
  - traitement_du_specialiste
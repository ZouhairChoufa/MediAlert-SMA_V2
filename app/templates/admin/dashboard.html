{% extends "base.html" %}

{% block title %}Admin Dashboard - MediAlert SMA{% endblock %}
{% block header %}ADMIN DASHBOARD{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="glass-panel p-6 rounded-xl border border-cyan-500/20">
            <div class="flex items-center justify-between mb-4">
                <i class="fas fa-users text-cyan-400 text-2xl"></i>
                <span class="text-xs text-slate-500">TOTAL</span>
            </div>
            <h3 class="text-3xl font-bold text-white mb-1">{{ stats.total_users }}</h3>
            <p class="text-sm text-slate-400">Utilisateurs</p>
        </div>
        
        <div class="glass-panel p-6 rounded-xl border border-green-500/20">
            <div class="flex items-center justify-between mb-4">
                <i class="fas fa-ambulance text-green-400 text-2xl"></i>
                <span class="text-xs text-slate-500">ACTIVES</span>
            </div>
            <h3 class="text-3xl font-bold text-white mb-1">{{ stats.active_alerts }}</h3>
            <p class="text-sm text-slate-400">Alertes en cours</p>
        </div>
        
        <div class="glass-panel p-6 rounded-xl border border-blue-500/20">
            <div class="flex items-center justify-between mb-4">
                <i class="fas fa-hospital text-blue-400 text-2xl"></i>
                <span class="text-xs text-slate-500">DISPONIBLES</span>
            </div>
            <h3 class="text-3xl font-bold text-white mb-1">18</h3>
            <p class="text-sm text-slate-400">Hôpitaux</p>
        </div>
        
        <div class="glass-panel p-6 rounded-xl border border-purple-500/20">
            <div class="flex items-center justify-between mb-4">
                <i class="fas fa-chart-line text-purple-400 text-2xl"></i>
                <span class="text-xs text-slate-500">AUJOURD'HUI</span>
            </div>
            <h3 class="text-3xl font-bold text-white mb-1">{{ stats.total_alerts }}</h3>
            <p class="text-sm text-slate-400">Total Alertes</p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="glass-panel p-6 rounded-xl border border-cyan-500/20 overflow-visible">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-cyan-400">
                    <i class="fas fa-users-cog mr-2"></i>Gestion Utilisateurs ({{ users|length }})
                </h3>
                <div class="flex space-x-2">
                    <button onclick="toggleCreateUser()" class="px-4 py-2 bg-cyan-500/20 text-cyan-400 rounded-lg hover:bg-cyan-500/30 transition-all text-sm">
                        <i class="fas fa-plus mr-1"></i>Nouveau
                    </button>
                    <button onclick="toggleImportModal()" class="px-4 py-2 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/30 transition-all text-sm">
                        <i class="fas fa-file-csv mr-1"></i>Importer CSV
                    </button>
                </div>
            </div>
                
            <div id="createUserForm" class="hidden mb-4 p-4 bg-slate-800/50 rounded-lg">
                <form method="POST" action="{{ url_for('admin.create_user') }}">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <input type="text" name="username" placeholder="Nom d'utilisateur" required class="bg-slate-900/50 border border-cyan-500/20 rounded-lg px-3 py-2 text-sm text-white">
                        <input type="email" name="email" placeholder="Email" required class="bg-slate-900/50 border border-cyan-500/20 rounded-lg px-3 py-2 text-sm text-white">
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="relative">
                            <input type="password" id="adminPassword" name="password" placeholder="Mot de passe" required class="bg-slate-900/50 border border-cyan-500/20 rounded-lg px-3 py-2 pr-10 text-sm w-full text-white">
                            <button type="button" onclick="togglePassword('adminPassword', this)" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-cyan-400">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <select name="role" class="bg-slate-900/50 border border-cyan-500/20 rounded-lg px-3 py-2 text-sm text-slate-300">
                            <option value="patient">Patient</option>
                            <option value="medecin">Médecin</option>
                            <option value="admin">Administrateur</option>
                        </select>
                    </div>
                    <div class="flex space-x-2">
                        <button type="submit" class="px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 text-sm">
                            <i class="fas fa-check mr-1"></i>Créer
                        </button>
                        <button type="button" onclick="toggleCreateUser()" class="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 text-sm">
                            Annuler
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="space-y-3 max-h-[240px] overflow-y-auto custom-scrollbar p-1">
                {% for user in users %}
                <div class="flex items-center justify-between p-3 rounded-lg transition-all duration-200 hover:bg-cyan-500/10 active:scale-[0.98] cursor-pointer group relative">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                        <div>
                            <a href="/admin/user/{{ user.username }}" class="text-sm font-medium text-white hover:text-cyan-400 transition-colors">
                                {{ user.username }}
                            </a>
                            <p class="text-xs text-slate-500">{{ user.email }}</p>
                        </div>
                    </div>

                    <div class="flex items-center space-x-2">
                        {% if user.role == 'admin' %}
                            <span class="bg-purple-100 text-purple-700 text-xs font-semibold px-2.5 py-0.5 rounded-full flex items-center gap-1 border border-purple-200"><i class="fas fa-user-shield"></i> Admin</span>
                        {% elif user.role == 'medecin' %}
                            <span class="bg-green-100 text-green-700 text-xs font-semibold px-2.5 py-0.5 rounded-full flex items-center gap-1 border border-green-200"><i class="fas fa-user-md"></i> Médecin</span>
                        {% else %}
                            <span class="bg-gray-100 text-gray-600 text-xs font-semibold px-2.5 py-0.5 rounded-full flex items-center gap-1 border border-gray-200"><i class="fas fa-user"></i> Patient</span>
                        {% endif %}
                        
                        <button onclick="toggleMenu(event, '{{ user.username }}')" class="p-2 hover:bg-slate-700/50 rounded-lg text-slate-400 hover:text-white transition-colors">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>

                <div id="menu-{{ user.username }}" class="action-menu hidden fixed 
                            bg-white text-blue-600 dark:bg-slate-800/25 backdrop-blur-md 
                            rounded-lg shadow-2xl border border-cyan-500/20 z-[9999] w-48 overflow-hidden">
                    
                    <a href="/admin/user/{{ user.username }}" class="block w-full text-left px-4 py-3 text-sm transition-colors border-b border-slate-100 dark:border-slate-700
                            text-slate-800 dark:text-white 
                            hover:bg-cyan-500/10">
                        <i class="fas fa-id-card mr-2 text-cyan-500"></i>Voir Profil
                    </a>
                    
                    <button onclick="openRoleModal('{{ user.username }}', '{{ user.role }}')" class="block w-full text-left px-4 py-3 text-sm transition-colors border-b border-slate-100 dark:border-slate-700
                            text-slate-800 dark:text-white 
                            hover:bg-cyan-500/10">
                        <i class="fas fa-user-tag mr-2 text-yellow-500"></i>Changer Rôle
                    </button>
                    
                    <button onclick="resetPasswordFrontend('{{ user.email }}')" class="block w-full text-left px-4 py-3 text-sm transition-colors border-b border-slate-100 dark:border-slate-700
                            text-slate-800 dark:text-white 
                            hover:bg-cyan-500/10">
                        <i class="fas fa-key mr-2 text-orange-500"></i>Reset Password
                    </button>
                    
                    {% if user.username != session.get('user') %}
                    <button onclick="showDeleteModal('{{ user.username }}')" class="block w-full text-left px-4 py-3 text-sm transition-colors
                            text-red-600 dark:text-red-400 
                            hover:bg-red-50 dark:hover:bg-red-500/10">
                        <i class="fas fa-trash mr-2"></i>Supprimer
                    </button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="glass-panel p-6 rounded-xl border border-cyan-500/20">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-cyan-400">
                    <i class="fas fa-cogs mr-2"></i>Paramètres Système
                </h3>
            </div>
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 rounded-lg transition-all duration-200 hover:bg-cyan-500/10">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-palette text-cyan-400"></i>
                        <div>
                            <span class="text-sm text-white">Mode Sombre/Clair</span>
                            <p class="text-xs text-slate-500">Autoriser les utilisateurs à changer de thème</p>
                        </div>
                    </div>
                    <div class="toggle-switch cursor-pointer z-10" onclick="toggleThemeSetting(event)" data-enabled="{{ theme_toggle_enabled|lower }}">
                        <div class="toggle-circle pointer-events-none"></div>
                    </div>
                </div>
                
                <a href="/admin/agents-documentation" class="flex items-center justify-between p-3 rounded-lg transition-all duration-200 hover:bg-cyan-500/10 active:scale-[0.98] cursor-pointer">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-robot text-cyan-400"></i>
                        <span class="text-sm text-white">Agents IA</span>
                    </div>
                    <span class="text-green-400 text-sm">7/7 Actifs</span>
                </a>
                <div class="flex items-center justify-between p-3 rounded-lg transition-all duration-200 hover:bg-cyan-500/10 active:scale-[0.98] cursor-pointer">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-database text-blue-400"></i>
                        <span class="text-sm text-white">Base de données</span>
                    </div>
                    <span class="text-green-400 text-sm">Opérationnelle</span>
                </div>
                <div class="flex items-center justify-between p-3 rounded-lg transition-all duration-200 hover:bg-cyan-500/10 active:scale-[0.98] cursor-pointer">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-map-marked-alt text-purple-400"></i>
                        <span class="text-sm text-white">Services de carte</span>
                    </div>
                    <span class="text-green-400 text-sm">Connecté</span>
                </div>
            </div>
        </div>
    </div>

    <div class="glass-panel p-6 rounded-xl border border-cyan-500/20">
        <h3 class="text-xl font-semibold text-cyan-400 mb-6">
            <i class="fas fa-history mr-2"></i>Activité Récente
        </h3>
        <div class="space-y-3 max-h-[700px] overflow-y-auto custom-scrollbar">
            {% for log in recent_logs %}
            <div class="flex items-center space-x-4 p-3 rounded-lg transition-all duration-200 hover:bg-cyan-500/10 active:scale-[0.98] cursor-pointer">
                <div class="w-2 h-2 rounded-full {% if log.event_type == 'alert_created' %}bg-green-500{% elif log.event_type == 'login' %}bg-blue-500{% else %}bg-cyan-500{% endif %}"></div>
                <div class="flex-1">
                    <p class="text-sm text-white">{{ log.message }}</p>
                    <p class="text-xs text-slate-500">{{ log.user or 'System' }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div id="deleteModal" class="hidden fixed inset-0 z-[9999] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="hideDeleteModal()"></div>
    <div class="relative glass-panel p-6 rounded-xl border border-red-500/30 max-w-md w-full mx-4 shadow-2xl">
        <div class="text-center">
            <div class="mx-auto w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">Supprimer l'utilisateur</h3>
            <p class="text-slate-400 mb-6">Êtes-vous sûr de vouloir supprimer cet utilisateur ? Cette action est irréversible.</p>
            <div class="flex space-x-3">
                <button onclick="hideDeleteModal()" class="flex-1 px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition-colors">Annuler</button>
                <button onclick="confirmDelete()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    <i class="fas fa-trash mr-2"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

{% for user in users %}
{% if user.username != session.get('user') %}
<form method="POST" action="{{ url_for('admin.delete_user', username=user.username) }}" id="deleteForm-{{ user.username }}" class="hidden"></form>
{% endif %}
{% endfor %}

<div id="importModal" class="hidden fixed inset-0 z-[9999] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="toggleImportModal()"></div>
    <div class="relative glass-panel p-6 rounded-xl border border-green-500/30 max-w-md w-full mx-4 shadow-2xl">
        <div class="text-center">
            <div class="mx-auto w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center mb-4">
                <i class="fas fa-file-csv text-green-500 text-2xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">Importer des utilisateurs</h3>
            <p class="text-slate-400 mb-6 text-sm">Sélectionnez un fichier CSV (Colonnes: Full Name, Email, Password, Ville, Specialite, Role)</p>
            
            <form method="POST" action="{{ url_for('admin.import_users') }}" enctype="multipart/form-data">
                <div class="mb-4">
                    <input type="file" name="file" accept=".csv" required 
                           class="w-full px-3 py-2 bg-slate-900/50 border border-green-500/20 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-green-500/20 file:text-green-400 hover:file:bg-green-500/30 cursor-pointer">
                </div>
                <div class="flex space-x-3">
                    <button type="button" onclick="toggleImportModal()" class="flex-1 px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition-colors">
                        Annuler
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-upload mr-2"></i>Importer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="roleModal" class="hidden fixed inset-0 z-[9999] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeRoleModal()"></div>
    <div class="relative glass-panel p-6 rounded-xl border border-cyan-500/30 max-w-sm w-full mx-4 shadow-2xl transform transition-all scale-100">
        <div class="text-center mb-4">
            <div class="mx-auto w-12 h-12 rounded-full bg-cyan-500/20 flex items-center justify-center mb-2">
                <i class="fas fa-user-tag text-cyan-400 text-xl"></i>
            </div>
            <h3 class="text-xl font-bold text-white">Modifier le Rôle</h3>
        </div>
        
        <form id="roleForm" method="POST" action="">
            <div class="mb-6 space-y-2">
                <label class="flex items-center p-3 rounded-lg border border-slate-700 bg-slate-800/50 cursor-pointer hover:bg-slate-700 transition-colors">
                    <input type="radio" name="role" value="patient" class="text-cyan-500 focus:ring-cyan-500 bg-slate-900 border-slate-600">
                    <span class="ml-3 text-white flex items-center gap-2"><i class="fas fa-user text-gray-400"></i> Patient</span>
                </label>
                <label class="flex items-center p-3 rounded-lg border border-slate-700 bg-slate-800/50 cursor-pointer hover:bg-slate-700 transition-colors">
                    <input type="radio" name="role" value="medecin" class="text-cyan-500 focus:ring-cyan-500 bg-slate-900 border-slate-600">
                    <span class="ml-3 text-white flex items-center gap-2"><i class="fas fa-user-md text-green-400"></i> Médecin</span>
                </label>
                <label class="flex items-center p-3 rounded-lg border border-slate-700 bg-slate-800/50 cursor-pointer hover:bg-slate-700 transition-colors">
                    <input type="radio" name="role" value="admin" class="text-cyan-500 focus:ring-cyan-500 bg-slate-900 border-slate-600">
                    <span class="ml-3 text-white flex items-center gap-2"><i class="fas fa-shield-alt text-purple-400"></i> Admin</span>
                </label>
            </div>
            
            <div class="flex space-x-3">
                <button type="button" onclick="closeRoleModal()" class="flex-1 px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition-colors">
                    Annuler
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-500 transition-colors shadow-lg shadow-cyan-500/20">
                    Enregistrer
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block scripts %}
<style>
/* Style du bouton Toggle (Cyan Thème) */
.toggle-switch {
    width: 60px;
    height: 30px;
    /* Fond Cyan très clair (similaire à bg-cyan-50 avec transparence) */
    background: rgba(180, 240, 255, 0.2); 
    border-radius: 15px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
    /* Bordure Cyan (similaire à border-cyan-100/300) */
    border: 1px solid rgba(34, 211, 238, 0.5); 
    z-index: 10;
    user-select: none;
}

/* État ACTIVÉ : Cyan plus soutenu */
.toggle-switch[data-enabled="true"] {
    background: rgba(6, 182, 212, 0.5); /* Cyan plus foncé */
    border-color: rgba(6, 182, 212, 1);  /* Bordure Cyan solide */
    box-shadow: 0 0 10px rgba(6, 182, 212, 0.3); /* Légère lueur */
}

/* Le cercle */
.toggle-circle {
    width: 24px;
    height: 24px;
    background: white;
    border-radius: 50%;
    position: absolute;
    top: 2px;
    left: 2px;
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(134, 218, 249, 0.1);
    pointer-events: none;
}

/* Déplacement du cercle */
.toggle-switch[data-enabled="true"] .toggle-circle {
    transform: translateX(30px);
}

/* IMPORTANT : Menu flottant toujours visible */
.action-menu {
    position: fixed !important;
    z-index: 10000 !important;
}

/* Sécurité pour les Modales */
.modal-overlay { z-index: 9998; }
.modal-content { z-index: 9999; }
</style>

<script>
// --- Debugging ---
console.log("Dashboard Scripts Loaded & Ready");

// --- Fonctions d'ouverture (Toggle) ---
function toggleCreateUser() {
    const el = document.getElementById('createUserForm');
    if(el) el.classList.toggle('hidden');
}

function toggleImportModal() {
    const modal = document.getElementById('importModal');
    if (modal) modal.classList.toggle('hidden');
}

// --- Menu Flottant "Bulletproof" (Déplacement dans le body) ---
function toggleMenu(event, username) {
    event.stopPropagation();
    event.preventDefault();
    
    console.log("Click détecté pour:", username);
    
    let menu = document.getElementById('menu-' + username);
    const button = event.currentTarget;
    
    if (!menu) {
        console.error("Erreur: Le menu avec l'ID 'menu-" + username + "' est introuvable !");
        return;
    }

    // 1. Fermer TOUS les autres menus ouverts
    document.querySelectorAll('.action-menu').forEach(m => {
        if (m !== menu) m.classList.add('hidden');
    });
    
    // 2. Ouvrir le menu actuel
    if (menu.classList.contains('hidden')) {
        // --- LA SOLUTION MAGIQUE : Déplacer le menu dans le body ---
        // Si le menu est encore dans la liste, on le déplace dans le body
        // pour qu'il ne soit jamais coupé par l'overflow de la liste.
        if (menu.parentNode !== document.body) {
            document.body.appendChild(menu);
        }

        menu.classList.remove('hidden');
        
        // --- Calcul de la position ---
        const rect = button.getBoundingClientRect();
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        
        const menuWidth = 192; // Largeur approx (w-48)
        const menuHeight = menu.offsetHeight || 200; 
        const windowHeight = window.innerHeight;
        
        // Position X (Aligné à droite du bouton)
        menu.style.left = (rect.right + scrollLeft - menuWidth) + 'px'; 
        
        // Position Y (Intelligente : Haut ou Bas ?)
        if (rect.bottom + menuHeight + 10 > windowHeight) {
            // Afficher au-dessus
            menu.style.top = (rect.top + scrollTop - menuHeight - 5) + 'px';
        } else {
            // Afficher en dessous
            menu.style.top = (rect.bottom + scrollTop + 5) + 'px';
        }
        
    } else {
        menu.classList.add('hidden');
    }
}

// --- Fermeture Globale ---
// Fermer les menus si on clique n'importe où ailleurs
document.addEventListener('click', (e) => {
    // Si on ne clique pas dans un menu ni sur un bouton d'action
    if (!e.target.closest('.action-menu') && !e.target.closest('button[onclick^="toggleMenu"]')) {
        document.querySelectorAll('.action-menu').forEach(m => m.classList.add('hidden'));
    }
});

// Fermer au scroll (pour éviter que le menu flotte n'importe où)
window.addEventListener('scroll', () => {
    document.querySelectorAll('.action-menu').forEach(m => m.classList.add('hidden'));
}, true);


// --- Gestion des Modales (Rôle & Suppression) ---

function openRoleModal(username, currentRole) {
    // Fermer le menu d'abord
    document.querySelectorAll('.action-menu').forEach(m => m.classList.add('hidden'));

    const modal = document.getElementById('roleModal');
    const form = document.getElementById('roleForm');
    
    if(modal && form) {
        // Mise à jour dynamique de l'URL avec les backticks corrects
        form.action = `/admin/user/${username}/role`;
        
        // Sélection du bouton radio correspondant au rôle actuel
        const radio = form.querySelector(`input[value="${currentRole}"]`);
        if (radio) radio.checked = true;
        
        modal.classList.remove('hidden');
    }
}

function closeRoleModal() {
    document.getElementById('roleModal').classList.add('hidden');
}

// Gestion Suppression
let currentDeleteUser = null;
function showDeleteModal(username) {
    document.querySelectorAll('.action-menu').forEach(m => m.classList.add('hidden'));
    currentDeleteUser = username;
    document.getElementById('deleteModal').classList.remove('hidden');
}
function hideDeleteModal() {
    currentDeleteUser = null;
    document.getElementById('deleteModal').classList.add('hidden');
}
function confirmDelete() {
    if (currentDeleteUser) {
        document.getElementById('deleteForm-' + currentDeleteUser).submit();
    }
}

// --- Utilitaires ---
function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.replace('fa-eye', 'fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.replace('fa-eye-slash', 'fa-eye');
    }
}

function resetPasswordFrontend(email) {
    document.querySelectorAll('.action-menu').forEach(m => m.classList.add('hidden'));
    if(typeof resetPasswordGlobal === 'function') {
        resetPasswordGlobal(email);
    } else {
        alert("Fonction resetPasswordGlobal non trouvée. Email: " + email);
    }
}

function toggleThemeSetting(event) {
    event.stopPropagation();
    const toggle = document.querySelector('.toggle-switch');
    const currentState = toggle.getAttribute('data-enabled') === 'true';
    const newState = !currentState;
    
    toggle.setAttribute('data-enabled', newState.toString());
    
    fetch('/admin/settings/theme-toggle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ enabled: newState })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) setTimeout(() => window.location.reload(), 300);
        else toggle.setAttribute('data-enabled', currentState.toString());
    });
}
</script>
{% endblock %}
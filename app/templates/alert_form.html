{% extends "base.html" %}

{% block title %}Nouvelle Alerte - MediAlert SMA{% endblock %}
{% block header %}NOUVELLE ALERTE D'URGENCE{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="glass-panel p-8">
        <form id="alertForm" class="space-y-6">
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm text-slate-400 mb-2">Nom & Pr√©nom</label>
                    <input type="text" name="nom_prenom" required
                        class="w-full bg-slate-800/50 border border-cyan-500/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-cyan-500/50">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">√Çge</label>
                        <input type="number" name="age" required
                            class="w-full bg-slate-800/50 border border-cyan-500/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-cyan-500/50">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Sexe</label>
                        <select name="sexe" required
                            class="w-full bg-slate-800/50 border border-cyan-500/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-cyan-500/50">
                            <option value="M">M</option>
                            <option value="F">F</option>
                        </select>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm text-slate-400 mb-2">Sympt√¥mes</label>
                <textarea name="symptomes" rows="4" required
                    class="w-full bg-slate-800/50 border border-cyan-500/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-cyan-500/50"
                    placeholder="D√©crivez les sympt√¥mes..."></textarea>
            </div>

            <div>
                <label class="block text-sm text-slate-400 mb-2">Localisation</label>
                <div class="relative">
                    <input type="text" id="locationInput" name="localisation" required
                        value="{{ location_data.city if location_data else '' }}"
                        class="w-full bg-slate-800/50 border border-cyan-500/20 rounded-lg px-4 py-3 pr-12 text-white focus:outline-none focus:border-cyan-500/50"
                        placeholder="Adresse ou ville">
                    <input type="hidden" id="lat" name="lat">
                    <input type="hidden" id="lng" name="lng">
                    <button type="button" id="detectLocationBtn" 
                        class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-cyan-500/20 hover:bg-cyan-500/30 flex items-center justify-center transition-all"
                        title="D√©tecter ma position">
                        <i class="fas fa-crosshairs text-cyan-400"></i>
                    </button>
                </div>
                <p class="text-xs text-slate-500 mt-2" id="locationStatus">
                    <i class="fas fa-location-dot"></i> 
                    Cliquez sur l'ic√¥ne pour d√©tecter votre position
                </p>
            </div>

            <button type="submit" 
                class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-4 rounded-lg font-semibold hover:shadow-lg hover:shadow-red-500/50 transition-all">
                <i class="fas fa-ambulance mr-2"></i>
                CR√âER ALERTE D'URGENCE
            </button>
        </form>
    </div>
</div>

<script>
// Location detection setup
const detectBtn = document.getElementById('detectLocationBtn');
const locationInput = document.getElementById('locationInput');
const locationStatus = document.getElementById('locationStatus');
const latInput = document.getElementById('lat');
const lngInput = document.getElementById('lng');

// --- GESTION DU BOUTON GPS ---
detectBtn.addEventListener('click', async () => {
    const icon = detectBtn.querySelector('i');
    icon.className = 'fas fa-spinner fa-spin text-cyan-400';
    locationStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> D√©tection en cours...';
    
    // Si l'utilisateur clique sur GPS, on vide le champ texte pour √©viter les conflits
    locationInput.value = ''; 

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                latInput.value = lat;
                lngInput.value = lng;
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
                    const data = await response.json();
                    locationInput.value = data.display_name || `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    locationStatus.innerHTML = `<i class="fas fa-check-circle text-green-400"></i> Position GPS d√©tect√©e`;
                } catch (e) {
                    locationInput.value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    locationStatus.innerHTML = '<i class="fas fa-check-circle text-green-400"></i> Position GPS d√©tect√©e';
                }
                icon.className = 'fas fa-crosshairs text-cyan-400';
            },
            async () => {
                // Fallback IP si GPS refus√©
                handleIpFallback(icon);
            }
        );
    } else {
        handleIpFallback(icon);
    }
});

async function handleIpFallback(icon) {
    try {
        const response = await fetch('/api/detect-ip-location', { method: 'POST' });
        const result = await response.json();
        if (result.success) {
            const loc = result.location;
            latInput.value = loc.lat;
            lngInput.value = loc.lng;
            locationInput.value = `${loc.city}, ${loc.country}`;
            locationStatus.innerHTML = '<i class="fas fa-info-circle text-yellow-400"></i> Position d√©tect√©e par IP';
        }
    } catch (e) {
        locationStatus.innerHTML = '<i class="fas fa-exclamation-circle text-red-400"></i> Erreur d√©tection';
    }
    icon.className = 'fas fa-crosshairs text-cyan-400';
}

// --- GESTION DE LA SOUMISSION (LOGIQUE CORRIG√âE) ---
const form = document.getElementById('alertForm');

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    
    // D√©sactiver le bouton imm√©diatement pour √©viter le double clic
    btn.disabled = true;
    
    try {
        console.log('\n=== ALERT FORM SUBMIT ===');
        
        // STEP 1: V√©rifier la saisie manuelle (Priorit√© 1)
        const manualAddress = locationInput.value && locationInput.value.trim();
        
        // Si l'utilisateur a √©crit une adresse, on la traite en priorit√© absolue
        if (manualAddress) {
            console.log('[FORM] üîç Adresse manuelle d√©tect√©e, lancement du g√©ocodage...');
            
            // UI Feedback
            btn.innerHTML = '<i class="fas fa-satellite-dish fa-spin mr-2"></i>V√âRIFICATION ADRESSE...';
            
            // On vide les anciennes coordonn√©es GPS (hidden inputs) pour forcer la nouvelle adresse
            latInput.value = '';
            lngInput.value = '';
            
            try {
                // Appel Backend (API Geocode) - AWAIT est crucial ici
                const geoResponse = await fetch('/api/geocode', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ address: manualAddress })
                });
                
                const geoResult = await geoResponse.json();
                
                if (geoResponse.ok && geoResult.lat && geoResult.lng) {
                    console.log('[FORM] ‚úÖ G√©ocodage r√©ussi:', geoResult);
                    latInput.value = geoResult.lat;
                    lngInput.value = geoResult.lng;
                } else {
                    console.warn('[FORM] ‚ö†Ô∏è √âchec g√©ocodage, envoi du texte brut au backend');
                }
            } catch (geoError) {
                console.error('[FORM] ‚ùå Erreur r√©seau g√©ocodage:', geoError);
            }
        } 
        
        // UI Feedback final
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ENVOI ALERTE...';

        // STEP 2: Pr√©paration des donn√©es
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        // STEP 3: Ajout des coordonn√©es finales si disponibles
        if (latInput.value && lngInput.value) {
            data.gps_coords = {
                lat: parseFloat(latInput.value),
                lng: parseFloat(lngInput.value),
                accuracy: manualAddress ? 10 : 50 
            };
            // On s'assure que lat/lng sont aussi √† la racine de l'objet JSON
            data.lat = parseFloat(latInput.value);
            data.lng = parseFloat(lngInput.value);
        }
        
        console.log('[FORM] Envoi des donn√©es finales:', data);

        // STEP 4: Envoi final
        const response = await fetch('/api/alert', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.alert_id) {
            console.log('[FORM] ‚úÖ Succ√®s, redirection...');
            window.location.href = `/tracking/${result.alert_id}`;
        } else {
            throw new Error(result.error || 'Erreur inconnue');
        }

    } catch (error) {
        console.error('[FORM] ‚ùå Erreur:', error);
        alert('Erreur lors de la cr√©ation de l\'alerte: ' + error.message);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});

// Gestion touche Entr√©e pour soumettre le formulaire
document.querySelectorAll('#alertForm input, #alertForm select').forEach(input => {
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            form.requestSubmit();
        }
    });
});
</script>
{% endblock %}